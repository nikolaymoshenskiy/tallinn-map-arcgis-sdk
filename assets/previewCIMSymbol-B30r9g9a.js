import{gd as F,ge as E,gf as L,dF as z,cD as G,dL as k}from"./index-CpEBwgYb.js";import{e as x,a as q,K as A}from"./CIMSymbolHelper-Dc62DEV1.js";import{i as T}from"./CIMResourceManager-CWLlf3xn.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-DuCZhugw.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./GeometryUtils-ZQdssNyK.js";import"./definitions-Y_v3njP4.js";import"./Rect-CUzevAry.js";import"./BoundingBox-r7-QpPxK.js";import"./imageUtils-CkkYmpoB.js";const U=96/72;class K{constructor(a){this._spatialReference=a,this._imageDataCanvas=null,this._cimResourceManager=new T}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(a,o,r,l,i,t,s,y,v){if(!a)return null;const{data:g}=a;if(!g||g.type!=="CIMSymbolReference"||!g.symbol)return null;const{symbol:C}=g;t||(t=F(C));const h=await E.resolveSymbolOverrides(g,o,this._spatialReference,i,t,s,y),d=this._cimResourceManager,w=[];x.fetchResources(h,d,w),x.fetchFonts(h,d,w),w.length>0&&await Promise.all(w);const{width:n,height:c}=r,M=O(t,n,c,l),e=x.getEnvelope(h,M,d);if(!e)return null;let m=1,R=0,I=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let f=1;e.width>n&&(f=n/e.width);let b=1;e.height>c&&(b=c/e.height),l==="preview"&&(e.width<n&&(f=n/e.width),e.height<c&&(b=c/e.height)),m=Math.min(f,b),R=e.x+e.width/2,I=e.y+e.height/2}break;case"CIMLineSymbol":{(v||e.height>c)&&(m=c/e.height),I=e.y+e.height/2;const f=e.x*m+n/2,b=(e.x+e.width)*m+n/2,{paths:S}=M;S[0][0][0]-=f/m,S[0][2][0]-=(b-n)/m}break;case"CIMPolygonSymbol":{R=e.x+e.width/2,I=e.y+e.height/2;const f=e.x*m+n/2,b=(e.x+e.width)*m+n/2,S=e.y*m+c/2,D=(e.y+e.height)*m+c/2,{rings:p}=M;f<0&&(p[0][0][0]-=f,p[0][3][0]-=f,p[0][4][0]-=f),S<0&&(p[0][0][1]+=S,p[0][1][1]+=S,p[0][4][1]+=S),b>n&&(p[0][1][0]-=b-n,p[0][2][0]-=b-n),D>c&&(p[0][2][1]+=D-c,p[0][3][1]+=D-c)}}const V={type:"cim",data:{type:"CIMSymbolReference",symbol:h}};return this.rasterize(V,n,c,R,I,m,t,1,M)}rasterize(a,o,r,l,i,t,s,y=0,v=null){const{data:g}=a;if(!g||g.type!=="CIMSymbolReference"||!g.symbol)return null;const{symbol:C}=g,h=this._canvas,d=(window.devicePixelRatio||1)*U;h.width=o*d,h.height=r*d,s||(s=F(C)),v||(v=O(s,o,r,"legend")),h.width+=2*y,h.height+=2*y;const w=h.getContext("2d",{willReadFrequently:!0}),n=A.createIdentity();return n.translate(-l,-i),n.scale(t*d,-t*d),n.translate(o*d/2+y,r*d/2+y),w.clearRect(0,0,h.width,h.height),new q(w,this._cimResourceManager,n,!0).drawSymbol(C,v),w.getImageData(0,0,h.width,h.height)}}function O(u,a,o,r){const i=-a/2+1,t=a/2-1,s=o/2-1,y=-o/2+1;switch(u){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[i,0],[0,0],[t,0]]]};default:return r==="legend"?{rings:[[[i,s],[t,0],[t,y],[i,y],[i,s]]]}:{rings:[[[i,s],[t,s],[t,y],[i,y],[i,s]]]}}}const _=new K(null),P=L(z.size),$=L(z.maxSize),j=L(z.lineWidth),W=1;async function B(u,a,o){const r=a==null?void 0:a.size;let l=r!=null&&typeof r=="object"&&"width"in r?r.width:r,i=r!=null&&typeof r=="object"&&"height"in r?r.height:r;if(l==null||i==null)if(o==="esriGeometryPolygon")l=P,i=P;else{const t=await H(u,a,o);t&&(l=t.width,i=t.height),o==="esriGeometryPolyline"&&(l=j),l=l!=null&&isFinite(l)?Math.min(l,$):P,i=i!=null&&isFinite(i)?Math.max(Math.min(i,$),W):P}return a.style==="legend"&&o==="esriGeometryPolyline"&&(l=j),{width:l,height:i}}async function H(u,a,o){const{feature:r,fieldMap:l,viewParams:i}=a.cimOptions||a,t=await E.resolveSymbolOverrides(u.data,r,null,l,o,null,i);if(!t)return null;(u=u.clone()).data={type:"CIMSymbolReference",symbol:t},u.data.primitiveOverrides=void 0;const s=[];return x.fetchResources(t,_.resourceManager,s),x.fetchFonts(t,_.resourceManager,s),s.length>0&&await Promise.all(s),x.getEnvelope(t,null,_.resourceManager)}async function re(u,a={}){var R;const{node:o,opacity:r,symbolConfig:l}=a,i=l!=null&&typeof l=="object"&&"isSquareFill"in l&&l.isSquareFill,t=a.cimOptions||a,s=t.geometryType||F((R=u==null?void 0:u.data)==null?void 0:R.symbol),y=await B(u,a,s),{feature:v,fieldMap:g}=t,C=i||s!=="esriGeometryPolygon"?"preview":"legend",h=await _.rasterizeCIMSymbolAsync(u,v,y,C,g,s,null,t.viewParams,t.allowScalingUp);if(!h)return null;const{width:d,height:w}=h,n=document.createElement("canvas");n.width=d,n.height=w,n.getContext("2d").putImageData(h,0,0);const c=G(y.width),M=G(y.height),e=new Image(c,M);e.src=n.toDataURL(),e.ariaLabel=a.ariaLabel??null,e.alt=a.ariaLabel??"",r!=null&&(e.style.opacity=`${r}`);let m=e;if(a.effectView!=null){const I={shape:{type:"image",x:0,y:0,width:c,height:M,src:e.src},fill:null,stroke:null,offset:[0,0]};m=k([[I]],[c,M],{effectView:a.effectView,ariaLabel:a.ariaLabel})}return o&&m&&o.appendChild(m),m}export{re as previewCIMSymbol};
